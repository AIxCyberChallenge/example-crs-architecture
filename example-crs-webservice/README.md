#### Example CRS Webservice

According to the released `AFC Procedures and Scoring Guide`:

'Teams must implement a set of services referred to as the "CRS API." for receiving tasks from the Competition Framework.'

' the CRS must implement the CRS API to enable CRS receipt of Challenges and broadcast
vulnerabilities. The CRS API must also include a method for obtaining health and metrics information. '

All endpoints, for the CRS API and Competition API must have a uniform implementation:

- Endpoints will be HTTP-based with JavaScript Object Notation (JSON) inputs, JSON outputs
  and return HTTP status codes
- All endpoints must support key/token authentication using HTTP Auth
- All endpoints must use HTTPS signed by a public Certificate Authority

In other words, competitors are expected to develop a web server for receiving task requests from the competition. This relationship is simplified in the diagram below.

```s
| Competition | <----> | CRS API Web Server |
```

The [example-crs-architecture](https://github.com/aixcc-finals/example-crs-architecture/tree/main/docs/api) repository provides the swagger specification files which may be used to autogenerate code for both the http server stub as well as the http client for sending submissions to the scoreboard.

- `competition-swagger-*.json` - description of the competition HTTP API
- `crs-swagger-*.json` - description of the CRS HTTP API

From the perspective of a competitor, `competition-swagger-*.json` may be used to autogenerate the http client for sending submissions to the scoreboard. `crs-swagger-*.json` may be used to autogenerate the http server stub for accepting tasks from the competition.

Provided in this repository is an example of the expected http client and http server code competitors are expected to implement that have been autogenerated and then manually corrected. Competitors may use this repository as a reference for CRS development.

#### Install

Install the dependencies for the package using the following `pip` command:

```bash
$ pip install -e .[tests]
```

Instead of installing the dependencies on your local machine, you may also use the compose.yaml.

#### Usage

**Competition API Client**

The `example-competition-api` provides a mock implementation of the competition API which will validate input formats and provide example outputs.

The complete instructions for running the `example-competition-server` are available under [example-competition-server/](https://github.com/aixcc-finals/example-crs-architecture/tree/main/example-competition-server).

All endpoints use HTTP Basic authentication.  Use `11111111-1111-1111-1111-111111111111` and `secret` as the credentials.
 
A basic UI showing API interactions and formats is available at `http://localhost:1323/swagger/`.

Test the Competition API client example implemented in `test_ping_api.py`.

```bash
$ pip install -e .[tests]
$ cd test
$ pytest -s test_ping_api.py
```

**CRS API Server**

The CRS API Web server can be started using the following commands:

```bash
docker compose up
```

The webserver will be accessible at `http://webservice:1324` in the `endpoint-network` docker network.

Alternatively, if you have installed dependencies on your host machine, and wish to run the server on your host machine, you may run the following commands.

```bash
$ cd my_crs/task_server
$ uvicorn server:app --reload --port 1324 --log-config=../../log-conf.yaml --env-file=../../submission.env
```

The web server will be accessible at `http://localhost:1324` by default.

The [generate-challenge-task](https://github.com/aixcc-finals/generate-challenge-task) script may be used to construct an HTTP request that the task server expects.

Alternatively, the `example-competition-server` may be used to generate and send tasks to the task server.

This can be performed by sending a web request to the `example-competition-server` which in turn will then send a request over the CRS API to the task server.

The example curl command below will stage a full scan task to the `example-competition-server` which will then send the task over to the task server.

```bash
curl -X 'POST' 'http://localhost:1323/webhook/trigger_task' -H 'Content-Type: application/json' -d '{
    "challenge_repo_url": "git@github.com:<challenge repo here>.git",
    "challenge_repo_head_ref": "<head ref hash here>",
    "fuzz_tooling_url": "https://github.com/aixcc-finals/oss-fuzz-aixcc.git",
    "fuzz_tooling_ref": "<fuzz-tooling ref hash here>",
    "fuzz_tooling_project_name": "<project name>",
    "duration": 3600
}'
```

#### Reproducing this repository

After generation from the specification file, the autogenerated code may require some corrections.

Detailed instructions for autogeneration of the code as well as manually added corrections are below.

**Competition API Client**

The client code for interacting with the competition scoreboard was autogenerated using `openapi-generator` following the provided instructions in the example-crs-architecture [Readme](https://github.com/aixcc-finals/example-crs-architecture/blob/main/docs/api/README.md#openapi-generator).

From the `example-crs-architecture`, repository run the following command using the `competition-swagger-*.json` specification file to autogenerate the Competition API client code:

```bash
$ docker run --rm -v $(realpath example-crs-architecture/docs/api):/local openapitools/openapi-generator-cli generate \
          -i /local/competition-swagger-v0.1.json \
          -g  python \
          -o /local/out
```

Located in `example-crs-architecture/docs/api/out` will be the autogenerated http client code.

After copying it over, the extraneous files can be removed and the project dependency files `pyproject.toml` can be consolidated into the top-level of the package.

Depending on where the package is placed, the imports will have to be modified, a simple find and replace using sed can be used to perform this replacement.

```
$ sed -i -e 's/from openapi_client./from <new-package-path>.openapi_client./' *.py
$ sed -i -e 's/import openapi_client./import <new-package-path>./' *.py
```

The HTTP client code can be tested against the provided `example-competition-api` available as a Docker container at `ghcr.io/aixcc-finals/example-crs-architecture/competition-test-api:v1.2-rc5`. This container provides a mock Competition API on port 1323.

Example code for how to interact with the `example-competition-api` has been added under `test/test_ping_api.py`.

**CRS API Web Server**

The CRS HTTP server code for receiving tasking from the competition was autogenerated using `fastapi-code-generator` after converting the provided `crs-swagger-*.json` file to an `openapi3` specification file.

The [swagger editor web ui](https://editor.swagger.io/) was used to convert the `crs-swagger-*.json` file into the `openapi3` format. The web editor only operates over `YAML` so afterwards the `YAML` file will need to be converted into `json`. This was performed using an online [YAML to json converter](https://onlineyamltools.com/convert-yaml-to-json).

Finally, the resulting `openapi3` json file can be used with `fastapi-code-generator` to autogenerate the CRS http server code following the instructions [here](https://github.com/GeorgeDimi/FastAPI_OpenAPI/tree/main).

The instructions have been reproduced below:

```bash
$ pip install fastapi-code-generator
$ pip install uvicorn
$ pip install fastapi
$ fastapi-codegen --input openapi.json --output task_server
```

`main.py` was renamed to `server.py`. The CRS API web server can then be run using the command `cd my_crs/task_server && uvicorn server:app --reload` and will be accessible at `http://localhost:8000` by default.

Additional fixes in order to run the autogenerated code include changes to the relative imports as well as adjustments to the autogenerated `pydantic` code under `models/types.py`.

The `Enum` classes must also contain `str` and all `UUID` types can be changed to `str`.

CRS HTTP endpoints are required to have Basic Authentication. The autogenerated server code has been modified to include an initial implementation of this based on the fastapi [documentation](https://fastapi.tiangolo.com/advanced/security/http-basic-auth/).

To ensure the task server implementation is correct, the [generate-challenge-task](https://github.com/aixcc-finals/generate-challenge-task) script may be used to construct an HTTP request that a task server expects.

#### Troubleshooting

When running `fastapi-codegen`, if one encounters `Exception: Modular references are not supported in this version`, this can be resolved with a monkey patch into the `fastapi` library as described [here](https://github.com/koxudaxi/fastapi-code-generator/issues/226).

`fastapi/lib/python3.12/site-packages/fastapi_code_generator/__main__.py` should be modified with the following code:

```diff
152a153,157
>     elif isinstance(models, dict):
>         output = output_dir / "models"
>         modules = {}
>         for path in models:
>             modules.update({output / path[0]: (models[path].body, input_name)})
```
